<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagn√≥stico da API Cloudflare</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        .test-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .test-section.running {
            border-color: #ffc107;
            background: #fff3cd;
        }
        .test-section.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .test-section.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            margin-left: 10px;
        }
        .status.pending { background: #6c757d; color: white; }
        .status.running { background: #ffc107; color: #212529; }
        .status.success { background: #28a745; color: white; }
        .status.error { background: #dc3545; color: white; }
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .error-box {
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .success-box {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .endpoint-test {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        .endpoint-test.success {
            border-color: #28a745;
            background: #f8fff9;
        }
        .endpoint-test.error {
            border-color: #dc3545;
            background: #fff8f8;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Diagn√≥stico da API Cloudflare</h1>
            <p>Teste completo para identificar problemas na configura√ß√£o da API</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
        </div>

        <div class="test-section" id="envTest">
            <h2>üîß 1. Verifica√ß√£o de Ambiente <span class="status pending" id="envStatus">Pendente</span></h2>
            <div id="envResults"></div>
        </div>

        <div class="test-section" id="urlTest">
            <h2>üåê 2. Teste de URLs da API <span class="status pending" id="urlStatus">Pendente</span></h2>
            <div id="urlResults"></div>
        </div>

        <div class="test-section" id="corsTest">
            <h2>üîí 3. Teste de CORS <span class="status pending" id="corsStatus">Pendente</span></h2>
            <div id="corsResults"></div>
        </div>

        <div class="test-section" id="endpointsTest">
            <h2>üì° 4. Teste de Endpoints <span class="status pending" id="endpointsStatus">Pendente</span></h2>
            <div id="endpointsResults"></div>
        </div>

        <div class="test-section" id="supabaseTest">
            <h2>üóÑÔ∏è 5. Teste de Configura√ß√£o Supabase <span class="status pending" id="supabaseStatus">Pendente</span></h2>
            <div id="supabaseResults"></div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button onclick="runAllTests()" id="runTestsBtn">üöÄ Executar Todos os Testes</button>
            <button onclick="clearLogs()" id="clearLogsBtn">üóëÔ∏è Limpar Logs</button>
        </div>

        <div class="test-section">
            <h2>üìù Logs Detalhados</h2>
            <div id="logs" class="log">Aguardando in√≠cio dos testes...\n</div>
        </div>
    </div>

    <script>
        let testProgress = 0;
        const totalTests = 5;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('logs');
            const typeEmoji = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'debug': 'üîç'
            };
            
            const logMessage = `[${timestamp}] ${typeEmoji[type] || '‚ÑπÔ∏è'} ${message}\n`;
            logDiv.textContent += logMessage;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logMessage.trim());
        }

        function updateProgress() {
            testProgress++;
            const percentage = (testProgress / totalTests) * 100;
            document.getElementById('progressBar').style.width = percentage + '%';
        }

        // Helper: resolve API base avoiding file:// origin
        function getApiBase() {
            try {
                const paramsApi = new URL(location.href).searchParams.get('api');
                if (paramsApi) return paramsApi.trim();
            } catch {}
            const isFile = location.protocol === 'file:';
            const isLocal = isFile || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            if (isLocal) return 'http://localhost:5175/api';
            return `${location.origin}/api`;
        }

        function setTestStatus(testId, status, message = '') {
            const section = document.getElementById(testId);
            const statusSpan = document.getElementById(testId.replace('Test', 'Status'));
            
            section.className = `test-section ${status}`;
            statusSpan.className = `status ${status}`;
            
            const statusText = {
                'pending': 'Pendente',
                'running': 'Executando...',
                'success': 'Sucesso',
                'error': 'Erro'
            };
            
            statusSpan.textContent = statusText[status] || status;
            
            if (message) {
                const resultsDiv = document.getElementById(testId.replace('Test', 'Results'));
                resultsDiv.innerHTML = message;
            }
        }

        async function testEnvironment() {
            log('üîß Iniciando teste de ambiente...', 'info');
            setTestStatus('envTest', 'running');
            
            try {
                const results = [];
                
                // Verificar se estamos em localhost ou produ√ß√£o
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                results.push(`<strong>Ambiente:</strong> ${isLocalhost ? 'Desenvolvimento (localhost)' : 'Produ√ß√£o'}`);
                results.push(`<strong>URL atual:</strong> ${window.location.href}`);
                results.push(`<strong>Hostname:</strong> ${window.location.hostname}`);
                results.push(`<strong>Protocol:</strong> ${window.location.protocol}`);
                
                // Simular detec√ß√£o da vari√°vel VITE_API_URL (n√£o podemos acessar diretamente no HTML)
                results.push(`<strong>Nota:</strong> Vari√°veis VITE_ s√≥ s√£o acess√≠veis durante o build do Vite`);
                
                const resultHtml = `<div class="success-box">${results.join('<br>')}</div>`;
                setTestStatus('envTest', 'success', resultHtml);
                log('‚úÖ Teste de ambiente conclu√≠do', 'success');
                
            } catch (error) {
                const errorHtml = `<div class="error-box">Erro: ${error.message}</div>`;
                setTestStatus('envTest', 'error', errorHtml);
                log(`‚ùå Erro no teste de ambiente: ${error.message}`, 'error');
            }
            
            updateProgress();
        }

        async function testApiUrls() {
            log('üåê Iniciando teste de URLs da API...', 'info');
            setTestStatus('urlTest', 'running');
            
            try {
                const possibleUrls = [
                    getApiBase(),
                    'http://localhost:5175/api',
                    `${window.location.origin}/api`,
                    'https://naturezabrindes.com.br/api',
                    'https://natureza-brindes.pages.dev/api'
                ];
                
                const results = [];
                
                for (const url of possibleUrls) {
                    try {
                        log(`üîç Testando URL: ${url}`, 'debug');
                        const response = await fetch(`${url}/health`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });
                        
                        const status = response.ok ? '‚úÖ' : '‚ùå';
                        results.push(`${status} <strong>${url}</strong> - Status: ${response.status}`);
                        
                        if (response.ok) {
                            log(`‚úÖ URL funcionando: ${url}`, 'success');
                        } else {
                            log(`‚ùå URL com problema: ${url} - Status: ${response.status}`, 'error');
                        }
                        
                    } catch (error) {
                        results.push(`‚ùå <strong>${url}</strong> - Erro: ${error.message}`);
                        log(`‚ùå Erro ao testar ${url}: ${error.message}`, 'error');
                    }
                }
                
                const resultHtml = `<div class="info-box">${results.join('<br>')}</div>`;
                setTestStatus('urlTest', results.some(r => r.includes('‚úÖ')) ? 'success' : 'error', resultHtml);
                log('üåê Teste de URLs conclu√≠do', 'info');
                
            } catch (error) {
                const errorHtml = `<div class="error-box">Erro: ${error.message}</div>`;
                setTestStatus('urlTest', 'error', errorHtml);
                log(`‚ùå Erro no teste de URLs: ${error.message}`, 'error');
            }
            
            updateProgress();
        }

        async function testCors() {
            log('üîí Iniciando teste de CORS...', 'info');
            setTestStatus('corsTest', 'running');
            
            try {
                const apiUrl = getApiBase();
                
                // Teste de preflight OPTIONS
                try {
                    const optionsResponse = await fetch(`${apiUrl}/health`, {
                        method: 'OPTIONS'
                    });
                    
                    const corsHeaders = {
                        'Access-Control-Allow-Origin': optionsResponse.headers.get('Access-Control-Allow-Origin'),
                        'Access-Control-Allow-Methods': optionsResponse.headers.get('Access-Control-Allow-Methods'),
                        'Access-Control-Allow-Headers': optionsResponse.headers.get('Access-Control-Allow-Headers')
                    };
                    
                    const results = [
                        `<strong>Preflight OPTIONS:</strong> ${optionsResponse.status === 200 ? '‚úÖ OK' : '‚ùå Falhou'}`,
                        `<strong>Allow-Origin:</strong> ${corsHeaders['Access-Control-Allow-Origin'] || 'N√£o definido'}`,
                        `<strong>Allow-Methods:</strong> ${corsHeaders['Access-Control-Allow-Methods'] || 'N√£o definido'}`,
                        `<strong>Allow-Headers:</strong> ${corsHeaders['Access-Control-Allow-Headers'] || 'N√£o definido'}`
                    ];
                    
                    const resultHtml = `<div class="info-box">${results.join('<br>')}</div>`;
                    setTestStatus('corsTest', 'success', resultHtml);
                    log('‚úÖ Teste de CORS conclu√≠do', 'success');
                    
                } catch (error) {
                    const errorHtml = `<div class="error-box">Erro no teste CORS: ${error.message}</div>`;
                    setTestStatus('corsTest', 'error', errorHtml);
                    log(`‚ùå Erro no teste de CORS: ${error.message}`, 'error');
                }
                
            } catch (error) {
                const errorHtml = `<div class="error-box">Erro: ${error.message}</div>`;
                setTestStatus('corsTest', 'error', errorHtml);
                log(`‚ùå Erro no teste de CORS: ${error.message}`, 'error');
            }
            
            updateProgress();
        }

        async function testEndpoints() {
            log('üì° Iniciando teste de endpoints...', 'info');
            setTestStatus('endpointsTest', 'running');
            
            const apiUrl = getApiBase();
            const endpoints = [
                { path: '/health', name: 'Health Check' },
                { path: '/products', name: 'Produtos' },
                { path: '/products/highlighted', name: 'Produtos em Destaque' },
                { path: '/products/categories/list', name: 'Categorias' }
            ];
            
            const results = [];
            
            for (const endpoint of endpoints) {
                try {
                    log(`üîç Testando endpoint: ${endpoint.path}`, 'debug');
                    
                    const response = await fetch(`${apiUrl}${endpoint.path}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const contentType = response.headers.get('content-type');
                    let data = null;
                    
                    if (contentType && contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        data = await response.text();
                    }
                    
                    const status = response.ok ? '‚úÖ' : '‚ùå';
                    results.push(`
                        <div class="endpoint-test ${response.ok ? 'success' : 'error'}">
                            <strong>${status} ${endpoint.name}</strong><br>
                            Status: ${response.status}<br>
                            Content-Type: ${contentType || 'N√£o definido'}<br>
                            ${response.ok ? `Dados: ${typeof data === 'object' ? JSON.stringify(data).substring(0, 100) + '...' : data.substring(0, 100) + '...'}` : `Erro: ${data}`}
                        </div>
                    `);
                    
                    if (response.ok) {
                        log(`‚úÖ Endpoint funcionando: ${endpoint.path}`, 'success');
                    } else {
                        log(`‚ùå Endpoint com problema: ${endpoint.path} - Status: ${response.status}`, 'error');
                    }
                    
                } catch (error) {
                    results.push(`
                        <div class="endpoint-test error">
                            <strong>‚ùå ${endpoint.name}</strong><br>
                            Erro: ${error.message}
                        </div>
                    `);
                    log(`‚ùå Erro ao testar ${endpoint.path}: ${error.message}`, 'error');
                }
            }
            
            const resultHtml = `<div class="grid">${results.join('')}</div>`;
            const hasSuccess = results.some(r => r.includes('success'));
            setTestStatus('endpointsTest', hasSuccess ? 'success' : 'error', resultHtml);
            log('üì° Teste de endpoints conclu√≠do', 'info');
            
            updateProgress();
        }

        async function testSupabaseConfig() {
            log('üóÑÔ∏è Iniciando teste de configura√ß√£o Supabase...', 'info');
            setTestStatus('supabaseTest', 'running');
            
            try {
                const apiUrl = getApiBase();
                
                // Tentar fazer uma requisi√ß√£o que force o uso do Supabase
                const response = await fetch(`${apiUrl}/products?limit=1`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                let results = [];
                
                if (response.ok) {
                    const data = await response.json();
                    results.push('‚úÖ Conex√£o com Supabase funcionando');
                    results.push(`‚úÖ API retornou dados: ${JSON.stringify(data).substring(0, 100)}...`);
                    
                    const resultHtml = `<div class="success-box">${results.join('<br>')}</div>`;
                    setTestStatus('supabaseTest', 'success', resultHtml);
                    log('‚úÖ Configura√ß√£o Supabase OK', 'success');
                    
                } else {
                    const errorText = await response.text();
                    results.push('‚ùå Problema na conex√£o com Supabase');
                    results.push(`Status: ${response.status}`);
                    results.push(`Erro: ${errorText}`);
                    
                    const resultHtml = `<div class="error-box">${results.join('<br>')}</div>`;
                    setTestStatus('supabaseTest', 'error', resultHtml);
                    log(`‚ùå Erro na configura√ß√£o Supabase: ${response.status} - ${errorText}`, 'error');
                }
                
            } catch (error) {
                const errorHtml = `<div class="error-box">Erro: ${error.message}</div>`;
                setTestStatus('supabaseTest', 'error', errorHtml);
                log(`‚ùå Erro no teste Supabase: ${error.message}`, 'error');
            }
            
            updateProgress();
        }

        async function runAllTests() {
            const btn = document.getElementById('runTestsBtn');
            btn.disabled = true;
            btn.textContent = 'üîÑ Executando Testes...';
            
            testProgress = 0;
            document.getElementById('progressBar').style.width = '0%';
            
            log('üöÄ Iniciando bateria completa de testes...', 'info');
            log('=' * 50, 'info');
            
            try {
                await testEnvironment();
                await testApiUrls();
                await testCors();
                await testEndpoints();
                await testSupabaseConfig();
                
                log('=' * 50, 'info');
                log('üéâ Todos os testes conclu√≠dos!', 'success');
                
            } catch (error) {
                log(`üí• Erro durante execu√ß√£o dos testes: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Executar Todos os Testes';
            }
        }

        function clearLogs() {
            document.getElementById('logs').textContent = 'Logs limpos...\n';
        }

        // Executar testes automaticamente ao carregar a p√°gina
        window.addEventListener('load', () => {
            log('üåü P√°gina carregada. Pronto para diagn√≥stico!', 'info');
            log('üí° Clique em "Executar Todos os Testes" para come√ßar', 'info');
        });
    </script>
</body>
</html>